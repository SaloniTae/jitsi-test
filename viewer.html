<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Viewer — Black background (no blurred background)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- JaaS external_api.js -->
<script src="https://8x8.vc/vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/external_api.js"></script>
<style>
  :root { --bg:#000; --panel:#071018; --panel-2:#0d1520; --text:#e6f0f3; --muted:#9fbac4; }
  html,body{height:100%; margin:0; font-family:system-ui,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text)}
  #main {display:flex; height:100vh; gap:0;}
  #left {flex:1; display:flex; flex-direction:column; background:var(--bg); min-width:0;}
  /* IMPORTANT: #jaas is black background */
  #jaas {flex:1; min-height:200px; background:var(--bg); position:relative; overflow:hidden;}
  .viewer-controls { position:absolute; right:12px; top:12px; z-index:9999; display:flex; gap:8px; align-items:center; }
  .viewer-controls button { background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.06); padding:8px 10px; color:var(--text); border-radius:6px; cursor:pointer; font-size:13px; }
  #debug {width:420px; background:var(--panel); border-left:1px solid #0f2533; overflow:auto; padding:10px; box-sizing:border-box;}
  #controls {height:56px; display:flex; gap:8px; align-items:center; padding:8px; background:var(--panel-2); border-radius:6px}
  button.big {padding:8px 12px;border-radius:6px;border:0;background:#1b2835;color:#fff;cursor:pointer}
  label{display:block;margin:8px 0 6px 0;font-size:13px}
  input[type=text]{width:100%;padding:8px;border-radius:6px;border:1px solid #0f2430;background:#021018;color:#fff;box-sizing:border-box}
  .small{font-size:12px;color:var(--muted)}
  .warn{color:#ffb3a7}
  #log {height:40vh; overflow:auto; background:#021018; color:#bfe7ff; padding:8px; border-radius:6px; font-size:12px}
  #participants {height:40vh; overflow:auto; background:#021018; color:#d0f0e8; padding:8px; border-radius:6px; margin-top:8px; font-size:12px}
  pre{white-space:pre-wrap; word-wrap:break-word; margin:0;}
  @media (max-width:900px){ #debug{display:none} }
</style>
</head>
<body>
<div id="main">
  <div id="left">
    <div id="jaas" aria-label="meeting">
      <div class="viewer-controls" id="viewerControls" style="display:none">
        <button id="btnUnhide">Show UI</button>
        <button id="btnFullscreen">Fullscreen</button>
      </div>
    </div>

    <div style="height:56px; display:flex; align-items:center; gap:8px; padding:8px; background:#071018;">
      <button id="btnInit" class="big">Init Viewer</button>
      <button id="btnMute" class="big">Toggle Mute</button>
      <button id="btnPinFirst" class="big">Pin First Remote</button>
      <button id="btnDump" class="big">Dump participants</button>
      <div style="margin-left:auto" class="small">Minimal viewer — black background</div>
    </div>
  </div>

  <div id="debug">
    <label>Config / Room</label>
    <input id="roomInput" type="text" value="vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/AyushLive"/>
    <label>Viewer JWT (leave blank to use no token)</label>
    <input id="jwtInput" type="text" value=""/>
    <label class="small">Event log (newest at bottom)</label>
    <div id="log"></div>

    <label class="small">Participants (updated live)</label>
    <div id="participants"><pre id="partsJson">—</pre></div>

    <div style="height:12px"></div>
    <div class="small warn">Note: The code sets DISABLE_VIDEO_BACKGROUND=true to stop the blurred large-video background. If you use a hosted JAAS instance that ignores this override, see fallback steps below.</div>
  </div>
</div>

<script>
(function(){
  const logEl = document.getElementById('log');
  const partsEl = document.getElementById('partsJson');
  const roomInput = document.getElementById('roomInput');
  const jwtInput = document.getElementById('jwtInput');

  let api = null;
  let joined = false;
  let lastMuteState = true;

  function appendLog(txt){
    const time = new Date().toLocaleTimeString();
    logEl.innerText += `[${time}] ${txt}\n`;
    logEl.scrollTop = logEl.scrollHeight;
    console.log(txt);
  }

  function renderParticipants(list){
    try { partsEl.innerText = JSON.stringify(list, null, 2); }
    catch(e){ partsEl.innerText = String(list); }
  }

  async function getParticipants(){
    if (!api) return;
    try {
      const info = api.getParticipantsInfo && api.getParticipantsInfo();
      const list = (info && typeof info.then === 'function') ? await info : info;
      renderParticipants(list || []);
      appendLog('getParticipantsInfo -> ' + (Array.isArray(list) ? list.length+' participants' : String(list)));
      return list;
    } catch(e){
      appendLog('getParticipantsInfo error: ' + e);
      console.warn(e);
      return null;
    }
  }

  function attachCommonHandlers(apiInstance){
    if(!apiInstance) return;
    const events = [
      'videoConferenceJoined','videoConferenceLeft','participantJoined','participantLeft',
      'participantKickedOut','participantRoleChanged','participantVideoStatusChanged',
      'screenSharingStatusChanged','videoMuteStatusChanged','audioMuteStatusChanged',
      'readyToClose','errorOccurred'
    ];
    events.forEach(ev => {
      try {
        apiInstance.addEventListener(ev, (payload) => {
          appendLog(ev + ' : ' + (payload && typeof payload === 'object' ? JSON.stringify(payload) : String(payload)));
          if (['participantJoined','participantLeft','participantVideoStatusChanged','screenSharingStatusChanged','participantRoleChanged','videoConferenceJoined'].includes(ev)) {
            setTimeout(getParticipants, 300);
          }
          if (ev === 'videoConferenceJoined') {
            // black background & hide filmstrip
            const jaas = document.getElementById('jaas');
            if (jaas) jaas.style.background = '#000';
            ensureHideFilmstrip(apiInstance);
            const vc = document.getElementById('viewerControls');
            if (vc) vc.style.display = 'flex';
          }
        });
      } catch(e){ console.warn('attach ev fail', ev, e); }
    });
  }

  // ensure filmstrip is hidden - call a few times
  function ensureHideFilmstrip(apiInstance){
    try {
      [0, 600, 1500].forEach((delay,i) => {
        setTimeout(()=> {
          try {
            apiInstance.executeCommand('toggleFilmStrip');
            appendLog('toggleFilmStrip called (attempt ' + (i+1) + ')');
          } catch(err){
            appendLog('toggleFilmStrip error: '+err);
          }
        }, delay);
      });
    } catch(e){ console.warn(e); }
  }

  async function initJitsi(){
    if (api) {
      appendLog('Viewer already initialized. Skipping re-create.');
      return;
    }

    const ROOM = roomInput.value.trim();
    const JWT = (jwtInput.value||'').trim();
    appendLog('Initializing Jitsi — ROOM=' + ROOM + ' — JWT present=' + (!!JWT));

    const options = {
      roomName: ROOM,
      parentNode: document.getElementById('jaas'),
      userInfo: { displayName: 'Viewer' },
      configOverwrite: {
        prejoinPageEnabled: false,
        startWithAudioMuted: true,
        startWithVideoMuted: true,
        disableDeepLinking: true,
        // improve screenshare fps if moderator wants higher fps for videos
        desktopSharingFrameRate: { min: 15, max: 30 }
      },
      interfaceConfigOverwrite: {
        TOOLBAR_BUTTONS: [],              // hide toolbar completely
        SHOW_JITSI_WATERMARK: false,
        SHOW_BRAND_WATERMARK: false,
        SHOW_POWERED_BY: false,
        SHOW_CHROME_EXTENSION_BANNER: false,
        SHOW_DEEP_LINKING_IMAGE: false,
        SHOW_WATERMARK_FOR_GUESTS: false,
        VIDEO_LAYOUT_FIT: 'both',
        filmStripOnly: false,
        SHOW_PARTICIPANT_NAME: false,
        /* === THIS is the key that disables the blurred large-video background === */
        DISABLE_VIDEO_BACKGROUND: true
      },
      width: '100%', height: '100%'
    };
    if (JWT) options.jwt = JWT;

    try {
      api = new JitsiMeetExternalAPI("8x8.vc", options);
      window.__debugApi = api;
      appendLog('External API created OK');
      attachCommonHandlers(api);

      api.addEventListener('videoConferenceJoined', () => {
        joined = true;
        appendLog('videoConferenceJoined: joined=true');
        const jaas = document.getElementById('jaas');
        if (jaas) jaas.style.background = '#000';
        ensureHideFilmstrip(api);
        setTimeout(getParticipants, 900);

        // Suggest higher assumed bandwidth (optional)
        try {
          api.executeCommand('setAssumedBandwidthBps', { assumedBandwidthBps: 2500000 });
          appendLog('setAssumedBandwidthBps called (2.5Mbps)');
        } catch(e){ /* ignore */ }
      });

      api.addEventListener('videoConferenceLeft', () => {
        joined = false;
        appendLog('videoConferenceLeft');
        const vc = document.getElementById('viewerControls');
        if (vc) vc.style.display = 'none';
      });

      setInterval(()=>{ if(api) getParticipants(); }, 2500);

    } catch (err){
      appendLog('ERROR creating ExternalAPI: ' + err);
      console.error(err);
      api = null;
    }
  }

  function toggleFullscreen() {
    const elem = document.getElementById('jaas');
    if (!document.fullscreenElement) {
      elem.requestFullscreen().catch(err => appendLog('Fullscreen error: '+err));
    } else {
      document.exitFullscreen().catch(err => appendLog('Exit fullscreen error: '+err));
    }
  }

  // controls
  document.getElementById('btnInit').addEventListener('click', ()=> initJitsi());
  document.getElementById('btnFullscreen').addEventListener('click', ()=> toggleFullscreen());
  document.getElementById('btnUnhide').addEventListener('click', ()=> {
    appendLog('Unhide request: toolbar was hidden by config; Jitsi UI remains but toolbar is suppressed.');
  });
  document.getElementById('btnPinFirst').addEventListener('click', async ()=>{
    if(!api){ appendLog('no api'); return; }
    const list = await getParticipants() || [];
    for(const p of list){
      const pid = p.participantId || p.id || p.participant;
      if(pid && pid !== api.getCurrentUserID()){
        try { api.executeCommand('setTileView', false); api.executeCommand('pinParticipant', pid); appendLog('Pinned: ' + pid); return; } catch(e){ appendLog('pin failed: '+e); }
      }
    }
    appendLog('No remote participant to pin.');
  });

  document.getElementById('btnMute').addEventListener('click', ()=>{
    if(!api){ appendLog('no api'); return; }
    try {
      lastMuteState = !lastMuteState;
      api.executeCommand(lastMuteState ? 'muteAudio' : 'unmuteAudio');
      appendLog('Audio ' + (lastMuteState ? 'muted' : 'unmuted'));
    } catch(e){ appendLog('mute toggle error: ' + e); }
  });

  document.getElementById('btnDump').addEventListener('click', async ()=>{
    if(!api) { appendLog('no api'); return; }
    try {
      const info = api.getParticipantsInfo && api.getParticipantsInfo();
      const list = (info && typeof info.then === 'function') ? await info : info;
      console.log('dump participants', list);
      appendLog('Dumped participants to console.');
    } catch(e){ appendLog('dump failed '+e); }
  });

  appendLog('Viewer ready. Click "Init Viewer" to join.');

  window.__viewerDebug = { initJitsi, getParticipants, apiRef: ()=>api, ensureHideFilmstrip };
})();
</script>
</body>
</html>
