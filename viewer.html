<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Viewer â€” Black background (auto-join, fullscreen landscape mobile, auto-pin screenshare)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<!-- JaaS external_api.js -->
<script src="https://8x8.vc/vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/external_api.js"></script>

<style>
  :root { --bg:#000; --text:#e6f0f3; }

  html,body{
    height:100%;
    margin:0;
    font-family:system-ui,Arial,Helvetica,sans-serif;
    background:var(--bg);
    color:var(--text);
    overflow:hidden;
  }

  #jaas{
    height:100vh;
    width:100vw;
    background:var(--bg);
    position:relative;
    overflow:hidden;
  }

  .viewer-controls{
    position:absolute;
    right:12px;
    top:12px;
    z-index:9999;
    display:none;
    gap:8px;
    align-items:center;
  }
  .viewer-controls button{
    background:rgba(255,255,255,0.06);
    border:1px solid rgba(255,255,255,0.06);
    padding:8px 10px;
    color:var(--text);
    border-radius:6px;
    cursor:pointer;
    font-size:13px;
  }

  /* --- CSS-fallback for mobile rotation ---- */
  .force-landscape{
    position:fixed !important;
    top:50% !important;
    left:50% !important;
    width:100vh !important;     /* swapped */
    height:100vw !important;    /* swapped */
    transform-origin:center center !important;
    transform:translate(-50%,-50%) rotate(90deg) !important;
    z-index:99999 !important;
    background:var(--bg) !important;
    overflow:hidden !important;
  }
</style>
</head>
<body>
  <div id="jaas" aria-label="meeting">
    <div class="viewer-controls" id="viewerControls">
      <button id="btnFullscreen">Fullscreen</button>
    </div>
  </div>

<script>
(function(){

  /* -------------------------------------------------
     1)  READ QUERY PARAM TO BUILD DISPLAY NAME
  --------------------------------------------------*/
  const qs = new URLSearchParams(window.location.search);
  const DISPLAY_NAME = qs.get('user') || 'Viewer';

  /* -------------------------------------------------
     2)  BASIC CONSTANTS FOR YOUR JITSI MEETING
  --------------------------------------------------*/
  const ROOM   = "vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/AyushLive";
  const DOMAIN = "8x8.vc";
  const JWT    = "";             // add token here if needed
  const ROOM_PASS = "12345";     // meeting password

  let api                     = null;
  let isForcingLandscapeViaCSS = false;

  /* -----------------------------------------------
     3)  HELPER: identify mobile/touch + small width
  ------------------------------------------------*/
  function isMobileOrTouchSmall(){
    try{
      const hasTouch = ('ontouchstart' in window) ||
                       (navigator.maxTouchPoints && navigator.maxTouchPoints>0);
      const smallW   = window.innerWidth <= 900;
      return hasTouch && smallW;
    }catch(e){ return false; }
  }

  /* -----------------------------------------------
     4)  HELPER: briefly toggle filmstrip (hide)
  ------------------------------------------------*/
  function ensureHideFilmstrip(apiInstance){
    try{
      setTimeout(() => {
        try{ apiInstance.executeCommand('toggleFilmStrip'); }catch(e){}
      }, 300);
    }catch(e){}
  }

  /* -----------------------------------------------
     5)  MAIN: create Jitsi IFrame
  ------------------------------------------------*/
  function initJitsi(){
    if(api) return;

    const options = {
      roomName: ROOM,
      parentNode: document.getElementById('jaas'),
      userInfo: { displayName: DISPLAY_NAME },
      configOverwrite:{
        prejoinPageEnabled:false,
        prejoinConfig:{enabled:false},
        disableInitialGUM:true,
        startWithAudioMuted:true,
        startWithVideoMuted:true,
        filmstrip:{disabled:true},
        desktopSharingFrameRate:{min:15,max:30}
      },
      interfaceConfigOverwrite:{
        TOOLBAR_BUTTONS:[],
        SHOW_JITSI_WATERMARK:false,
        SHOW_BRAND_WATERMARK:false,
        SHOW_POWERED_BY:false,
        SHOW_CHROME_EXTENSION_BANNER:false,
        SHOW_DEEP_LINKING_IMAGE:false,
        SHOW_WATERMARK_FOR_GUESTS:false,
        VIDEO_LAYOUT_FIT:'both',
        filmStripOnly:false,
        SHOW_PARTICIPANT_NAME:false,
        DISABLE_VIDEO_BACKGROUND:true
      },
      width:'100%',
      height:'100%'
    };
    if(JWT) options.jwt = JWT;

    try{
      api = new JitsiMeetExternalAPI(DOMAIN, options);

      /* ------------ auto-password ------------------- */
      api.addEventListener('participantRoleChanged', e=>{
        if(e.role === 'moderator'){
          try{ api.executeCommand('password', ROOM_PASS);}catch(e){}
        }
      });
      api.addEventListener('passwordRequired', ()=>{
        try{ api.executeCommand('password', ROOM_PASS);}catch(e){}
      });
      /* --------------------------------------------- */

      /* ------------ conference joined --------------- */
      api.addEventListener('videoConferenceJoined', async ()=>{
        document.getElementById('jaas').style.background='#000';
        ensureHideFilmstrip(api);
        document.getElementById('viewerControls').style.display='flex';

        // if someone already sharing -> pin them
        try{
          const info = api.getParticipantsInfo && api.getParticipantsInfo();
          const list = (info && typeof info.then === 'function') ? await info : info;
          if(Array.isArray(list)){
            const sharer = list.find(p=>p.isSharingScreen || p.videoType==='desktop' || p.videoType==='screen' || p.screen || p.screenShare);
            if(sharer){
              const pid = sharer.participantId || sharer.id || sharer.participant;
              if(pid && api.getCurrentUserID && pid !== api.getCurrentUserID()){
                try{
                  api.executeCommand('setTileView', false);
                  api.executeCommand('pinParticipant', pid);
                }catch(e){}
              }
            }
          }
        }catch(e){}
      });

      /* ------------ exit ---------------------------- */
      api.addEventListener('videoConferenceLeft', ()=>{
        document.getElementById('viewerControls').style.display='none';
      });

      /* ---------- auto-pin when share starts -------- */
      api.addEventListener('screenSharingStatusChanged', async payload=>{
        try{
          const pid = payload && (payload.id || payload.participantId || payload.participant);
          if(pid && api.getCurrentUserID && pid !== api.getCurrentUserID()){
            api.executeCommand('setTileView', false);
            api.executeCommand('pinParticipant', pid);
            return;
          }
          const info = api.getParticipantsInfo && api.getParticipantsInfo();
          const list = (info && typeof info.then === 'function') ? await info : info;
          if(Array.isArray(list)){
            const sharer = list.find(p=>p.isSharingScreen || p.videoType==='desktop' || p.videoType==='screen' || p.screen || p.screenShare);
            if(sharer){
              const foundId = sharer.participantId || sharer.id || sharer.participant;
              if(foundId && api.getCurrentUserID && foundId !== api.getCurrentUserID()){
                api.executeCommand('setTileView', false);
                api.executeCommand('pinParticipant', foundId);
              }
            }
          }
        }catch(e){}
      });

      /* -------- participant joined (if sharing) ----- */
      api.addEventListener('participantJoined', async ()=>{
        try{
          const info = api.getParticipantsInfo && api.getParticipantsInfo();
          const list = (info && typeof info.then === 'function') ? await info : info;
          if(Array.isArray(list)){
            const sharer = list.find(p=>p.isSharingScreen || p.videoType==='desktop' || p.videoType==='screen' || p.screen || p.screenShare);
            if(sharer){
              const pid = sharer.participantId || sharer.id || sharer.participant;
              if(pid && api.getCurrentUserID && pid !== api.getCurrentUserID()){
                api.executeCommand('setTileView', false);
                api.executeCommand('pinParticipant', pid);
              }
            }
          }
        }catch(e){}
      });

    }catch(err){
      console.error('ExternalAPI error', err);
      api = null;
    }
  }

  /* -----------------------------------------------
     6)  ORIENTATION / FULLSCREEN helpers
  ------------------------------------------------*/
  function tryLockOrientation(orientation){
    if(!orientation) return Promise.reject();
    if(screen.orientation && typeof screen.orientation.lock === 'function')
      return screen.orientation.lock(orientation);

    const maybe = screen.lockOrientation || screen.mozLockOrientation || screen.msLockOrientation;
    if(typeof maybe === 'function'){
      try{
        const ok = maybe.call(screen, orientation);
        return (ok && typeof ok.then==='function') ? ok : Promise.resolve(ok);
      }catch(e){ return Promise.reject(e); }
    }
    return Promise.reject();
  }

  function tryUnlockOrientation(){
    try{
      if(screen.orientation && typeof screen.orientation.unlock==='function')
        screen.orientation.unlock();
      else if(screen.unlockOrientation) screen.unlockOrientation();
      else if(screen.mozUnlockOrientation) screen.mozUnlockOrientation();
      else if(screen.msUnlockOrientation) screen.msUnlockOrientation();
    }catch(e){}
  }

  function applyCssLandscapeFallback(){
    if(!isMobileOrTouchSmall() || isForcingLandscapeViaCSS) return;
    const jaas = document.getElementById('jaas');
    if(!jaas) return;
    document.body.style.overflow='hidden';
    jaas.classList.add('force-landscape');
    isForcingLandscapeViaCSS = true;
  }

  function removeCssLandscapeFallback(){
    if(!isForcingLandscapeViaCSS) return;
    const jaas = document.getElementById('jaas');
    if(!jaas) return;
    jaas.classList.remove('force-landscape');
    document.body.style.overflow='';
    isForcingLandscapeViaCSS=false;
  }

  async function enterFullscreenAndLandscape(){
    const el = document.getElementById('jaas');
    if(!el) return;
    try{
      if(el.requestFullscreen)      await el.requestFullscreen();
      else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
      else if(el.msRequestFullscreen)     await el.msRequestFullscreen();
    }catch(e){}
    try{
      await tryLockOrientation('landscape');
      removeCssLandscapeFallback();
    }catch(e){
      applyCssLandscapeFallback();
    }
  }

  async function exitFullscreenAndRestore(){
    try{
      if(document.exitFullscreen) await document.exitFullscreen();
      else if(document.webkitExitFullscreen) await document.webkitExitFullscreen();
      else if(document.msExitFullscreen) await document.msExitFullscreen();
    }catch(e){}
    tryUnlockOrientation();
    removeCssLandscapeFallback();
  }

  function toggleFullscreen(){
    if(!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement)
      enterFullscreenAndLandscape();
    else
      exitFullscreenAndRestore();
  }

  function onFullScreenChange(){
    const full = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
    if(!full){
      tryUnlockOrientation();
      removeCssLandscapeFallback();
    }
  }

  /* -----------------------------------------------
     7)  INIT on window load
  ------------------------------------------------*/
  document.addEventListener('fullscreenchange', onFullScreenChange);
  document.addEventListener('webkitfullscreenchange', onFullScreenChange);
  document.addEventListener('msfullscreenchange', onFullScreenChange);

  window.addEventListener('load', ()=>{
    initJitsi();
    document.getElementById('btnFullscreen').addEventListener('click', toggleFullscreen);
  });

})();
</script>
</body>
</html>
