<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Viewer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- JaaS external_api.js -->
<script src="https://8x8.vc/vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/external_api.js"></script>

<!-- Firebase (RTDB only) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<style>
  :root { --bg:#000; --text:#e6f0f3; }

  html,body{
    height:100%;margin:0;overflow:hidden;
    font-family:system-ui,Arial,Helvetica,sans-serif;
    background:var(--bg);color:var(--text);
  }

  #jaas{height:100vh;width:100vw;position:relative;background:var(--bg);overflow:hidden;}

  .viewer-controls{
    position:absolute;right:12px;top:12px;z-index:9999;
    display:none;gap:8px;align-items:center;
  }
  .viewer-controls button{
    background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.06);
    padding:8px 10px;color:var(--text);border-radius:6px;cursor:pointer;font-size:13px;
  }

  .force-landscape{
    position:fixed !important;top:50%!important;left:50%!important;
    width:100vh!important;height:100vw!important;transform:translate(-50%,-50%) rotate(90deg)!important;
    transform-origin:center center!important;background:var(--bg)!important;overflow:hidden!important;z-index:99999!important;
  }

  /* unauthorized text */
  #unauth{
    position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
    background:#000;color:#e33;font-size:22px;font-weight:600;
  }
</style>
</head>
<body>
  <div id="jaas" aria-label="meeting">
    <div class="viewer-controls" id="viewerControls">
      <button id="btnFullscreen">Fullscreen</button>
    </div>
    <div id="unauth" style="display:none">Unauthorized / invalid link</div>
  </div>

<script>
(function(){

/* ------------------------------------------------------------------
   1)  Query-param extraction
-------------------------------------------------------------------*/
const qs  = new URLSearchParams(window.location.search);
const ORDER_ID = (qs.get('user') || '').trim().toUpperCase();

/* ------------------------------------------------------------------
   2)  Firebase config  (YOUR project)
-------------------------------------------------------------------*/
const firebaseConfig = {
  apiKey:"AIzaSyA02dPt8yMTSmhzyj9PIrm4UlWr1a1waD4",
  authDomain:"testing-6de54.firebaseapp.com",
  databaseURL:"https://testing-6de54-default-rtdb.firebaseio.com",
  projectId:"testing-6de54",
  storageBucket:"testing-6de54.appspot.com",
  messagingSenderId:"159795986690",
  appId:"1:159795986690:web:2e4de44d725826dc01821b",
  measurementId:"G-47XZRFJJGB"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ------------------------------------------------------------------
   3)  Constants for the Jitsi meeting
-------------------------------------------------------------------*/
const ROOM        = "vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/AyushLive";
const DOMAIN      = "8x8.vc";
const JWT         = "";          // supply if you use tokens
const ROOM_PASS   = "12345";     // meeting password

let api                      = null;
let isForcingLandscapeViaCSS = false;

/* =============  HELPER: show / hide unauthorized layer =========== */
function setUnauthorized(flag=true){
  document.getElementById('unauth').style.display = flag ? 'flex' : 'none';
}

/* ------------------------------------------------------------------
   4)  Validation against Firebase
-------------------------------------------------------------------*/
async function validateOrderId(id){
  if(!id) return false;
  try{
    const snap = await db.ref('transactions/'+id).get();
    if(!snap.exists()) return false;
    const tx = snap.val();
    if(tx.hidden) return false;

    const now = new Date();
    const st  = new Date(tx.start_time);
    const et  = new Date(tx.end_time);

    if(now < st || now > et) return false;
    return true;
  }catch(e){
    console.error('Firebase error',e);
    return false;
  }
}

/* ------------------------------------------------------------------
   5)  Jitsi helpers (all original logic)
-------------------------------------------------------------------*/
function isMobileOrTouchSmall(){
  try{
    const touch = ('ontouchstart' in window) || (navigator.maxTouchPoints && navigator.maxTouchPoints>0);
    const small = window.innerWidth<=900;
    return touch && small;
  }catch(e){return false;}
}

function ensureHideFilmstrip(apiInstance){
  try{setTimeout(()=>{try{apiInstance.executeCommand('toggleFilmStrip');}catch(e){}},300);}catch(e){}
}

function tryLockOrientation(o){
  if(!o) return Promise.reject();
  if(screen.orientation && typeof screen.orientation.lock==='function')
    return screen.orientation.lock(o);
  const maybe = screen.lockOrientation||screen.mozLockOrientation||screen.msLockOrientation;
  if(typeof maybe==='function'){
    try{
      const res = maybe.call(screen,o);
      return (res && typeof res.then==='function')?res:Promise.resolve(res);
    }catch(e){return Promise.reject(e);}
  }
  return Promise.reject();
}
function tryUnlockOrientation(){
  try{
    if(screen.orientation && screen.orientation.unlock) screen.orientation.unlock();
    else if(screen.unlockOrientation) screen.unlockOrientation();
    else if(screen.mozUnlockOrientation) screen.mozUnlockOrientation();
    else if(screen.msUnlockOrientation) screen.msUnlockOrientation();
  }catch(e){}
}
function applyCssLandscapeFallback(){
  if(!isMobileOrTouchSmall()||isForcingLandscapeViaCSS) return;
  const el=document.getElementById('jaas');
  if(!el) return;
  document.body.style.overflow='hidden';
  el.classList.add('force-landscape');
  isForcingLandscapeViaCSS=true;
}
function removeCssLandscapeFallback(){
  if(!isForcingLandscapeViaCSS) return;
  const el=document.getElementById('jaas');
  if(!el) return;
  el.classList.remove('force-landscape');
  document.body.style.overflow='';
  isForcingLandscapeViaCSS=false;
}
async function enterFullscreenAndLandscape(){
  const el=document.getElementById('jaas');if(!el)return;
  try{
    if(el.requestFullscreen)await el.requestFullscreen();
    else if(el.webkitRequestFullscreen)await el.webkitRequestFullscreen();
    else if(el.msRequestFullscreen)await el.msRequestFullscreen();
  }catch(e){}
  try{await tryLockOrientation('landscape');removeCssLandscapeFallback();}
  catch(e){applyCssLandscapeFallback();}
}
async function exitFullscreenAndRestore(){
  try{
    if(document.exitFullscreen)await document.exitFullscreen();
    else if(document.webkitExitFullscreen)await document.webkitExitFullscreen();
    else if(document.msExitFullscreen)await document.msExitFullscreen();
  }catch(e){}
  tryUnlockOrientation();removeCssLandscapeFallback();
}
function toggleFullscreen(){
  const full = document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement;
  if(!full)enterFullscreenAndLandscape();else exitFullscreenAndRestore();
}
function onFSChange(){
  const full = document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement;
  if(!full){tryUnlockOrientation();removeCssLandscapeFallback();}
}

/* ------------------------------------------------------------------
   6)  Initialise Jitsi (unchanged except displayName)
-------------------------------------------------------------------*/
function initJitsi(){
  if(api) return;
  const opt = {
    roomName: ROOM,
    parentNode: document.getElementById('jaas'),
    userInfo: { displayName: ORDER_ID },
    configOverwrite:{
      prejoinPageEnabled:false,prejoinConfig:{enabled:false},
      disableInitialGUM:true,startWithAudioMuted:true,startWithVideoMuted:true,
      filmstrip:{disabled:true},desktopSharingFrameRate:{min:15,max:30}
    },
    interfaceConfigOverwrite:{
      TOOLBAR_BUTTONS:[],SHOW_JITSI_WATERMARK:false,SHOW_BRAND_WATERMARK:false,
      SHOW_POWERED_BY:false,SHOW_CHROME_EXTENSION_BANNER:false,SHOW_DEEP_LINKING_IMAGE:false,
      SHOW_WATERMARK_FOR_GUESTS:false,VIDEO_LAYOUT_FIT:'both',filmStripOnly:false,
      SHOW_PARTICIPANT_NAME:false,DISABLE_VIDEO_BACKGROUND:true
    },
    width:'100%',height:'100%'
  };
  if(JWT) opt.jwt = JWT;

  try{
    api = new JitsiMeetExternalAPI(DOMAIN,opt);

    /* auto-password */
    api.addEventListener('participantRoleChanged',e=>{
      if(e.role==='moderator'){try{api.executeCommand('password',ROOM_PASS);}catch(e){}}
    });
    api.addEventListener('passwordRequired',()=>{try{api.executeCommand('password',ROOM_PASS);}catch(e){}});

    /* other original listeners */
    api.addEventListener('videoConferenceJoined', async ()=>{
      document.getElementById('viewerControls').style.display='flex';
      ensureHideFilmstrip(api);

      // pin sharer if already present
      try{
        const info=api.getParticipantsInfo&&api.getParticipantsInfo();
        const list=(info&&typeof info.then==='function')?await info:info;
        if(Array.isArray(list)){
          const s=list.find(p=>p.isSharingScreen||p.videoType==='desktop'||p.videoType==='screen'||p.screen||p.screenShare);
          if(s){
            const pid=s.participantId||s.id||s.participant;
            if(pid&&api.getCurrentUserID&&pid!==api.getCurrentUserID()){
              api.executeCommand('setTileView',false);
              api.executeCommand('pinParticipant',pid);
            }
          }
        }
      }catch(e){}
    });

    api.addEventListener('videoConferenceLeft',()=>{
      document.getElementById('viewerControls').style.display='none';
    });

    api.addEventListener('screenSharingStatusChanged',async payload=>{
      try{
        const pid = payload&&(payload.id||payload.participantId||payload.participant);
        if(pid&&api.getCurrentUserID&&pid!==api.getCurrentUserID()){
          api.executeCommand('setTileView',false);
          api.executeCommand('pinParticipant',pid);return;
        }
        const info=api.getParticipantsInfo&&api.getParticipantsInfo();
        const list=(info&&typeof info.then==='function')?await info:info;
        if(Array.isArray(list)){
          const s=list.find(p=>p.isSharingScreen||p.videoType==='desktop'||p.videoType==='screen'||p.screen||p.screenShare);
          if(s){
            const found=s.participantId||s.id||s.participant;
            if(found&&api.getCurrentUserID&&found!==api.getCurrentUserID()){
              api.executeCommand('setTileView',false);
              api.executeCommand('pinParticipant',found);
            }
          }
        }
      }catch(e){}
    });

    api.addEventListener('participantJoined',async ()=>{
      try{
        const info=api.getParticipantsInfo&&api.getParticipantsInfo();
        const list=(info&&typeof info.then==='function')?await info:info;
        if(Array.isArray(list)){
          const s=list.find(p=>p.isSharingScreen||p.videoType==='desktop'||p.videoType==='screen'||p.screen||p.screenShare);
          if(s){
            const pid=s.participantId||s.id||s.participant;
            if(pid&&api.getCurrentUserID&&pid!==api.getCurrentUserID()){
              api.executeCommand('setTileView',false);
              api.executeCommand('pinParticipant',pid);
            }
          }
        }
      }catch(e){}
    });

  }catch(err){console.error('ExternalAPI error',err);}
}

/* ------------------------------------------------------------------
   7)  Boot-strap on load
-------------------------------------------------------------------*/
document.addEventListener('fullscreenchange', onFSChange);
document.addEventListener('webkitfullscreenchange', onFSChange);
document.addEventListener('msfullscreenchange', onFSChange);

window.addEventListener('load', async ()=>{
  document.getElementById('btnFullscreen').addEventListener('click', toggleFullscreen);

  const ok = await validateOrderId(ORDER_ID);
  if(!ok){
    setUnauthorized(true);
    return;    // abort
  }
  setUnauthorized(false);       // hide message
  initJitsi();                  // start meeting
});

})();
</script>
</body>
</html>
