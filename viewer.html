<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Viewer — Fullscreen-only</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- JaaS external_api (replace MAGIC_COOKIE in src if different) -->
  <script src="https://8x8.vc/vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/external_api.js"></script>

  <style>
    :root { --bg: #000; --panel: #0f1113; --muted:#9faab0; --btn:#222; --btnText:#fff; }
    html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif}
    /* outer wrapper (we fullscreen this, not the iframe) */
    #video-wrap{height:calc(100vh - 56px);position:relative;display:flex;align-items:center;justify-content:center;background:#000}
    /* jitsi iframe container */
    #jaas{width:100%;height:100%;background:#000}
    /* placeholder shown until host is detected */
    #placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);z-index:3;font-size:16px;background:#000}
    /* control bar (only fullscreen button) */
    #controls{height:56px;display:flex;align-items:center;justify-content:center;background:var(--panel);border-top:1px solid #111}
    button{padding:10px 14px;border-radius:8px;background:var(--btn);color:var(--btnText);border:0;cursor:pointer;font-size:15px}
    button[disabled]{opacity:.45;cursor:not-allowed}
    /* ensure Jitsi iframe covers container */
    #jaas iframe{width:100% !important;height:100% !important;border:0;display:block}
    /* fullscreen outer wrapper black */
    :fullscreen #video-wrap, :-webkit-full-screen #video-wrap { background:#000; }
  </style>
</head>
<body>
  <div id="video-wrap" aria-live="polite">
    <div id="placeholder">Waiting for host to start sharing…</div>
    <div id="jaas" aria-label="meeting"></div>
  </div>
  <div id="controls">
    <button id="fsBtn" disabled>Fullscreen</button>
  </div>

<script>
/* ====== CONFIG - set these ====== */
const ROOM = "vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/AyushLive"; // fully-qualified JaaS room
const VIEWER_JWT = "PASTE_VIEWER_JWT_HERE"; // put your viewer token here (for quick test)
/* ================================= */

const apiHost = "8x8.vc"; // JaaS host
const placeholder = document.getElementById('placeholder');
const fsBtn = document.getElementById('fsBtn');
const jaas = document.getElementById('jaas');
const videoWrap = document.getElementById('video-wrap');

let api = null;
let joined = false;
let lastPinnedId = null;

// Initialize the Jitsi iframe as a viewer with toolbar hidden
(function init() {
  const opts = {
    roomName: ROOM,
    parentNode: jaas,
    userInfo: { displayName: 'Viewer_' + Math.floor(Math.random()*9000) },
    configOverwrite: {
      prejoinPageEnabled: false,
      startWithAudioMuted: true,
      startWithVideoMuted: true,
      disableDeepLinking: true,
      enableWelcomePage: false
    },
    interfaceConfigOverwrite: {
      TOOLBAR_BUTTONS: [],           // hide all toolbar buttons
      SHOW_JITSI_WATERMARK: false,
      SHOW_BRAND_WATERMARK: false,
      SHOW_POWERED_BY: false
    },
    width: "100%",
    height: "100%"
  };
  if (VIEWER_JWT && VIEWER_JWT.trim()) opts.jwt = VIEWER_JWT;

  try {
    api = new JitsiMeetExternalAPI(apiHost, opts);
    window.__viewerApi = api;
  } catch (err) {
    console.error("ExternalAPI init failed:", err);
    placeholder.textContent = "Failed to load meeting (see console).";
    return;
  }

  // event handlers: join, participants, screenshare
  api.addEventListener('videoConferenceJoined', () => {
    joined = true;
    fsBtn.disabled = false; // enable fullscreen
    // immediate attempt to pin host if present
    aggressivePinHost();
    // ensure participants pane hidden (run a few times for reliability)
    hideParticipantsPaneRepeated();
  });

  api.addEventListener('participantJoined', () => { setTimeout(aggressivePinHost, 600); });
  api.addEventListener('participantLeft', (p) => {
    if (p && (p.participantId === lastPinnedId || p.id === lastPinnedId)) lastPinnedId = null;
    setTimeout(aggressivePinHost, 600);
  });

  api.addEventListener('screenSharingStatusChanged', (payload) => {
    if (payload && payload.on) {
      hidePlaceholder();
      // if payload may include id, pin quickly
      const pid = payload.participantId || payload.id || payload.participant;
      if (pid) tryPin(pid);
      else aggressivePinHost();
      hideParticipantsPaneRepeated();
    } else {
      // re-evaluate after share stops
      setTimeout(aggressivePinHost, 700);
      hideParticipantsPaneRepeated();
    }
  });

  api.addEventListener('participantVideoStatusChanged', (evt) => {
    const pid = evt && (evt.participantId || evt.id);
    if (evt && (evt.videoStatus === true) && pid && pid !== api.getCurrentUserID()) {
      hidePlaceholder();
      tryPin(pid);
      hideParticipantsPaneRepeated();
    }
  });

  // periodic re-check to keep host pinned
  setInterval(() => { if (joined) aggressivePinHost(); }, 3000);

  // fullscreen/orientation hooks: force single-large view and pin host
  document.addEventListener('fullscreenchange', () => setTimeout(() => { api && tryExecute('setTileView', false); aggressivePinHost(); hideParticipantsPaneRepeated(); }, 200));
  window.addEventListener('orientationchange', () => setTimeout(() => { api && tryExecute('setTileView', false); aggressivePinHost(); hideParticipantsPaneRepeated(); }, 250));
})();

// -------- helpers --------

function hidePlaceholder(){ placeholder.style.display = 'none'; }
function showPlaceholder(){ placeholder.style.display = 'flex'; }

function tryExecute(cmd, ...args) {
  try { api && api.executeCommand && api.executeCommand(cmd, ...args); return true; } catch(e){ /* ignore */ return false; }
}

async function getParticipants() {
  try {
    if (!api || typeof api.getParticipantsInfo !== 'function') return [];
    const info = api.getParticipantsInfo();
    const list = (info && typeof info.then === 'function') ? await info : info;
    return Array.isArray(list) ? list : [];
  } catch (e) { return []; }
}

function tryPin(pid) {
  if (!pid || !api) return false;
  tryExecute('setTileView', false);
  try {
    api.executeCommand('pinParticipant', pid);
    lastPinnedId = pid;
    hidePlaceholder();
    return true;
  } catch (e) {
    try { api.executeCommand('setLargeVideoParticipant', pid); lastPinnedId = pid; hidePlaceholder(); return true; } catch(e2){ return false; }
  }
}

async function findHostCandidate() {
  const list = await getParticipants();
  if (!list || list.length === 0) return null;
  // heuristics: prefer screen sharer, then any with video, then first remote
  for (const p of list) {
    const pid = p.participantId || p.id || p.participant;
    if (!pid || pid === api.getCurrentUserID()) continue;
    const features = p.features || {};
    const isSharing = p.isScreensharing || p.isSharingScreen || features.screenSharing;
    if (isSharing) return pid;
  }
  for (const p of list) {
    const pid = p.participantId || p.id || p.participant;
    if (!pid || pid === api.getCurrentUserID()) continue;
    if (p.hasVideo || p.videoStatus || p.video) return pid;
  }
  const firstRemote = list.find(u => (u.participantId || u.id) && ((u.participantId || u.id) !== api.getCurrentUserID()));
  return firstRemote ? (firstRemote.participantId || firstRemote.id || firstRemote.participant) : null;
}

async function aggressivePinHost(retries = 4, delayMs = 400) {
  for (let i=0;i<retries;i++){
    const pid = await findHostCandidate();
    if (pid) { if (tryPin(pid)) return true; }
    await new Promise(r => setTimeout(r, delayMs));
  }
  // no candidate found yet
  showPlaceholder();
  return false;
}

// Try to hide the participants side pane by toggling it (call multiple times to ensure closed)
function hideParticipantsPaneRepeated(times = 3, gap = 220) {
  for (let i=0;i<times;i++){
    setTimeout(()=> {
      tryExecute('toggleParticipantsPane'); // best-effort - some versions support this
      // also try to force single large view
      tryExecute('setTileView', false);
      // also try to pin known lastPinnedId
      if (lastPinnedId) tryPin(lastPinnedId);
    }, i * gap);
  }
}

// attempt to pin then ensure placeholder hidden
function pinAndHide(pid) { tryPin(pid); hidePlaceholder(); }

// Fullscreen button logic — only enabled after joined
fsBtn.addEventListener('click', async () => {
  if (!api || !joined) { placeholder.textContent = "Joining… please wait"; return; }
  try {
    if (videoWrap.requestFullscreen) await videoWrap.requestFullscreen();
    else if (videoWrap.webkitRequestFullscreen) await videoWrap.webkitRequestFullscreen();
    // after FS, ensure view is large and host pinned
    setTimeout(() => { tryExecute('setTileView', false); aggressivePinHost(); hideParticipantsPaneRepeated(); }, 300);
  } catch (e) { console.warn('fullscreen failed', e); }
});
</script>
</body>
</html>
