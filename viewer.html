<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Viewer — Debug + Aggressive Pin (JaaS)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- external_api.js for your JaaS magic cookie (do not change unless self-hosting) -->
<script src="https://8x8.vc/vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/external_api.js"></script>

<style>
  :root{--bg:#000;--panel:#071019;--muted:#9fbac4}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--panel);color:#e6f0f3}
  #wrap{display:flex;height:100vh;gap:8px}
  /* left: meeting */
  #left{flex:1;display:flex;flex-direction:column;background:#000;border-radius:6px;overflow:hidden}
  #jaas{flex:1;min-height:280px;background:#000}
  #video-controls{height:56px;display:flex;gap:8px;align-items:center;padding:8px;background:#071019;border-top:1px solid #0e2735}
  .btn{padding:8px 12px;border-radius:6px;border:0;background:#1b2835;color:#fff;cursor:pointer}
  .btn[disabled]{opacity:.45;cursor:not-allowed}
  #placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#bbb;z-index:3;font-size:18px;background:#000}
  #status{position:absolute;left:10px;top:10px;padding:6px 8px;border-radius:6px;background:rgba(0,0,0,0.45);font-size:13px;color:var(--muted);z-index:4}
  /* right: debug */
  #right{width:420px;display:flex;flex-direction:column;gap:8px;padding:10px;box-sizing:border-box;background:#071019;border-radius:6px}
  label{font-size:13px;color:#9fbac4;margin-top:8px}
  input[type=text], textarea{width:100%;padding:8px;border-radius:6px;border:1px solid #0f2430;background:#021018;color:#e6f0f3;box-sizing:border-box}
  #log{height:46vh;overflow:auto;background:#021018;padding:8px;border-radius:6px;font-size:12px;color:#bfe7ff}
  #parts{height:42vh;overflow:auto;background:#021018;padding:8px;border-radius:6px;font-size:12px;color:#d0f0e8;white-space:pre-wrap}
  .small{font-size:12px;color:#9fbac4;margin-top:6px}
  footer{font-size:12px;color:#9fbac4;margin-top:10px}
  #controls-top{display:flex;gap:6px;align-items:center}
</style>
</head>
<body>
<div id="wrap">
  <div id="left">
    <div style="position:relative;flex:1;display:block">
      <div id="status">status: idle</div>
      <div id="placeholder">Waiting for host to start sharing…</div>
      <div id="jaas" aria-label="meeting"></div>
    </div>

    <div id="video-controls">
      <div id="controls-top" style="flex:1">
        <button id="btnReinitHide" class="btn">Re-init (hide UI)</button>
        <button id="btnReinitShow" class="btn">Re-init (show UI)</button>
        <button id="btnPinHost" class="btn">Pin Host</button>
        <button id="btnForcePin" class="btn">Force Pin x3</button>
        <button id="btnClosePane" class="btn">Try Close Pane</button>
      </div>

      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnFull" class="btn">Fullscreen</button>
        <button id="btnRefresh" class="btn">Refresh participants</button>
      </div>
    </div>
  </div>

  <div id="right">
    <label>Room (fully-qualified):</label>
    <input id="roomInput" type="text" value="vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/AyushLive"/>

    <label>Viewer JWT (paste here for JaaS; leave empty to test without JWT)</label>
    <textarea id="jwtInput" rows="3" placeholder="paste viewer jwt here"></textarea>

    <div class="small">Event log (newest at bottom)</div>
    <div id="log">—</div>

    <div class="small">Participants (getParticipantsInfo)</div>
    <div id="parts">—</div>

    <div class="small">Quick tips:
      <ul>
        <li>Open Host first and share screen (host must be in same room).</li>
        <li>Use Re-init (hide UI) to create viewer with hidden toolbar + pin logic.</li>
        <li>Click Pin Host or Force Pin if auto-pin fails; check event log for errors.</li>
      </ul>
    </div>

    <footer>viewer debug — aggressive pin & single-large view</footer>
  </div>
</div>

<script>
/* Viewer Debug + Aggressive Pin Implementation
   - Re-init (hide UI) will create a viewer with TOOLBAR_BUTTONS: []
   - Aggressive pin logic will attempt to pin the screen-sharer and set single-large view.
   - The right pane shows event log and participants for diagnosis.
*/

const statusEl = document.getElementById('status');
const placeholder = document.getElementById('placeholder');
const jaas = document.getElementById('jaas');
const logEl = document.getElementById('log');
const partsEl = document.getElementById('parts');

const roomInput = document.getElementById('roomInput');
const jwtInput = document.getElementById('jwtInput');

const btnReinitHide = document.getElementById('btnReinitHide');
const btnReinitShow = document.getElementById('btnReinitShow');
const btnPinHost = document.getElementById('btnPinHost');
const btnForcePin = document.getElementById('btnForcePin');
const btnClosePane = document.getElementById('btnClosePane');
const btnRefresh = document.getElementById('btnRefresh');
const btnFull = document.getElementById('btnFull');

let api = null;
let joined = false;
let lastPinnedId = null;
let autoPinInterval = null;

function appendLog(txt){
  const t = new Date().toLocaleTimeString();
  logEl.innerText += `[${t}] ${txt}\n`;
  logEl.scrollTop = logEl.scrollHeight;
  console.log(txt);
}
function setStatus(s){ statusEl.textContent = 'status: ' + s; appendLog(s); }
function showPlaceholder(){ placeholder.style.display = 'flex'; }
function hidePlaceholder(){ placeholder.style.display = 'none'; }

// safe executeCommand wrapper
function exec(cmd, ...args){
  try { api && api.executeCommand && api.executeCommand(cmd, ...args); return true; }
  catch(e){ appendLog('exec ' + cmd + ' failed: ' + e); return false; }
}

// create or recreate jitsi iframe
async function initJitsi(showUI = false){
  // teardown existing
  try { if (api && api.dispose) { api.dispose(); } } catch(e){ console.warn(e); }
  jaas.innerHTML = '';
  joined = false;
  lastPinnedId = null;
  setStatus('initializing...');
  showPlaceholder();

  const ROOM = (roomInput.value || '').trim();
  const JWT = (jwtInput.value || '').trim();

  const options = {
    roomName: ROOM,
    parentNode: jaas,
    userInfo: { displayName: 'Viewer-' + Math.floor(Math.random()*999) },
    configOverwrite: {
      prejoinPageEnabled: false,
      startWithAudioMuted: true,
      startWithVideoMuted: true,
      disableDeepLinking: true,
      enableWelcomePage: false
    },
    interfaceConfigOverwrite: {
      TOOLBAR_BUTTONS: showUI ? undefined : [], // hide toolbar in hide-UI mode
      SHOW_JITSI_WATERMARK: showUI,
      SHOW_BRAND_WATERMARK: showUI,
      SHOW_POWERED_BY: showUI
    },
    width: '100%', height: '100%'
  };
  if (JWT) options.jwt = JWT;

  try {
    api = new JitsiMeetExternalAPI('8x8.vc', options);
    window.__viewerDebugApi = api;
    appendLog('ExternalAPI created (showUI=' + showUI + ', jwt=' + (JWT? 'YES':'NO') + ')');
  } catch (err){
    appendLog('ExternalAPI creation failed: ' + err);
    setStatus('init failed');
    return;
  }

  attachListeners();
  setTimeout(() => { refreshParticipants(); }, 1000);
  // start a short auto-pin monitor every 3.5s while joined
  if (autoPinInterval) clearInterval(autoPinInterval);
  autoPinInterval = setInterval(()=>{ if (joined) aggressivePinHost(2,250).catch(()=>{}); }, 3500);
}

// attach event listeners to api
function attachListeners(){
  if (!api) return;
  const events = [
    'videoConferenceJoined','videoConferenceLeft','participantJoined','participantLeft',
    'participantVideoStatusChanged','screenSharingStatusChanged','readyToClose','errorOccurred'
  ];
  events.forEach(ev => {
    try {
      api.addEventListener(ev, (payload) => {
        appendLog(ev + (payload ? ' ' + JSON.stringify(payload) : ''));
        if (ev === 'videoConferenceJoined') {
          joined = true; setStatus('joined'); hidePlaceholder(); refreshParticipants();
          // try initial pin
          setTimeout(()=>{ aggressivePinHost(5,300).catch(()=>{}); }, 400);
        } else if (ev === 'videoConferenceLeft') {
          joined = false; setStatus('left'); showPlaceholder();
        } else if (['participantJoined','participantLeft','participantVideoStatusChanged','screenSharingStatusChanged'].includes(ev)) {
          setTimeout(refreshParticipants, 350);
        }
      });
    } catch(e){ console.warn('attach', ev, e); }
  });
}

// fetch participants and show in right pane
async function refreshParticipants(){
  if (!api) return;
  try {
    const info = api.getParticipantsInfo && api.getParticipantsInfo();
    const list = (info && typeof info.then === 'function') ? await info : info;
    partsEl.innerText = JSON.stringify(list || [], null, 2);
    appendLog('refreshParticipants -> ' + (Array.isArray(list) ? list.length + ' participants' : String(list)));
    return list || [];
  } catch (e){
    appendLog('refreshParticipants error: ' + e);
    return [];
  }
}

// heuristics to choose host candidate
async function findHostCandidate(){
  const list = await refreshParticipants();
  if (!Array.isArray(list) || list.length === 0) return null;
  // 1) prefer someone sharing screen
  for (const p of list){
    const pid = p.participantId || p.id || p.participant;
    if (!pid || pid === (api.getCurrentUserID && api.getCurrentUserID())) continue;
    const features = p.features || {};
    const isSharing = p.isScreensharing || p.isSharingScreen || features.screenSharing;
    if (isSharing) return pid;
  }
  // 2) prefer have video
  for (const p of list){
    const pid = p.participantId || p.id || p.participant;
    if (!pid || pid === (api.getCurrentUserID && api.getCurrentUserID())) continue;
    if (p.hasVideo || p.videoStatus || p.video) return pid;
  }
  // 3) fallback first remote
  const first = list.find(x => (x.participantId || x.id) && ((x.participantId || x.id) !== (api.getCurrentUserID && api.getCurrentUserID())));
  return first ? (first.participantId || first.id || first.participant) : null;
}

// pin helpers
function pinParticipant(pid){
  if (!api || !pid) return false;
  try { exec('setTileView', false); } catch(e){}
  try { exec('pinParticipant', pid); lastPinnedId = pid; appendLog('Pinned ' + pid); hidePlaceholder(); return true; }
  catch(e){ appendLog('pinParticipant failed: ' + e); }
  try { exec('setLargeVideoParticipant', pid); lastPinnedId = pid; hidePlaceholder(); return true; } catch(e){}
  return false;
}

async function aggressivePinHost(retries = 4, delayMs = 300){
  for (let i=0;i<retries;i++){
    const pid = await findHostCandidate();
    if (pid){
      if (pinParticipant(pid)) return true;
    }
    await new Promise(r => setTimeout(r, delayMs));
  }
  appendLog('aggressivePinHost: no candidate found');
  // keep placeholder visible
  showPlaceholder();
  return false;
}

// try to close participants pane / filmstrip (best-effort)
function tryCloseParticipantPane(){
  if (!api) return;
  ['toggleParticipantsPane','toggleFilmStrip','hideParticipants','toggleFilmStripView','toggleRemoteParticipantsPane'].forEach(cmd=>{
    try { exec(cmd); } catch(e){}
  });
  try { exec('setTileView', false); } catch(e){}
}

// UI button handlers
btnReinitHide.addEventListener('click', ()=> initJitsi(false));
btnReinitShow.addEventListener('click', ()=> initJitsi(true));
btnRefresh.addEventListener('click', ()=> refreshParticipants());
btnPinHost.addEventListener('click', async ()=> {
  setStatus('manual pin requested');
  const pid = await findHostCandidate();
  if (!pid) { appendLog('PinHost: no candidate'); return; }
  pinParticipant(pid);
});
btnForcePin.addEventListener('click', async ()=> {
  setStatus('force pin x3');
  for (let i=0;i<3;i++){ await aggressivePinHost(2,200); await new Promise(r=>setTimeout(r,200)); }
});
btnClosePane.addEventListener('click', ()=> { tryCloseParticipantPane(); setStatus('tried close pane'); });

btnFull.addEventListener('click', async ()=> {
  // fullscreen the left container (jaas area) to avoid internal prejoin
  const el = document.getElementById('left');
  try {
    if (el.requestFullscreen) await el.requestFullscreen();
    else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
  } catch(e){ appendLog('fullscreen failed: ' + e); }
});

// convenience: auto-init hide UI once page loads (do not auto-run if you want manual)
window.addEventListener('load', ()=> {
  // do not auto-init if not wanted; user should click re-init
  appendLog('viewer_debug_impl ready — click Re-init (hide UI) to start');
});

// expose helpers for manual console debugging
window.__viewerDebugImpl = {
  initJitsi, refreshParticipants, findHostCandidate, aggressivePinHost, pinParticipant, tryCloseParticipantPane, apiRef: ()=> api
};
</script>
</body>
</html>
