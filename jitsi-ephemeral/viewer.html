<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Viewer — Protected embed</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root { --bg:#000; --text:#e6f0f3; }
  html,body{height:100%;margin:0;font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;}
  #jaas{height:100vh;width:100vw;position:relative;background:var(--bg);}
  .viewer-controls{position:absolute;right:12px;top:12px;display:none;gap:8px;align-items:center;z-index:9999;}
  .viewer-controls button{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);padding:8px 10px;color:var(--text);border-radius:6px;cursor:pointer;font-size:13px;}
  #status{position:absolute;left:12px;top:12px;font-size:13px;color:#9fb2b8;z-index:9999;}
  #meetFrame{width:100%;height:100vh;border:0;display:block;background:var(--bg);}
</style>
</head>
<body>
<div id="jaas">
  <div id="status">Connecting…</div>
  <div class="viewer-controls" id="viewerControls">
    <button id="btnFullscreen">Fullscreen</button>
  </div>
</div>

<script>
(async function(){
  const SERVICE_BASE = "https://oor-islive.onrender.com";

  const statusEl = document.getElementById('status');
  const viewerControls = document.getElementById('viewerControls');

  function setStatus(text){ if(statusEl) statusEl.textContent = text; }

  async function requestJoin() {
    setStatus("Requesting secure join URL…");
    try {
      const resp = await fetch(`${SERVICE_BASE}/api/request-join`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ room:"AyushLive" })
      });

      if(!resp.ok){
        const err = await resp.text().catch(()=>null);
        console.error("request-join failed", resp.status, err);
        setStatus("Unable to get join link");
        return;
      }

      const data = await resp.json();
      if(!data?.joinUrl){ setStatus("Failed to get join link"); return; }

      setStatus("Embedding meeting…");

      const iframe = document.createElement('iframe');
      iframe.id='meetFrame';
      iframe.src = data.joinUrl; // server-side sets provider iframe dynamically
      iframe.allow = 'camera; microphone; fullscreen; clipboard-write';
      iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups';

      const jaas = document.getElementById('jaas');
      jaas.innerHTML='';
      jaas.appendChild(iframe);

      if(viewerControls) viewerControls.style.display='flex';
      setStatus("Joined — enjoy the meeting");

    } catch(err){
      console.error('requestJoin error',err);
      setStatus("Network error — retrying in 3s…");
      setTimeout(requestJoin,3000);
    }
  }

  const fsBtn = document.getElementById('btnFullscreen');
  if(fsBtn) fsBtn.addEventListener('click', ()=>{ 
    const el = document.getElementById('jaas'); 
    if(el.requestFullscreen) el.requestFullscreen(); 
  });

  window.addEventListener('load', ()=>{ requestJoin(); });
})();
</script>
</body>
</html>
