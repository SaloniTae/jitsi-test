<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Viewer — Protected embed</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  :root { --bg:#000; --text:#e6f0f3; }
  html,body{height:100%; margin:0; font-family:system-ui,Arial,Helvetica,sans-serif; background:var(--bg); color:var(--text); overflow:hidden;}
  #jaas {height:100vh; background:var(--bg); position:relative; overflow:hidden; width:100vw;}
  .viewer-controls { position:absolute; right:12px; top:12px; z-index:9999; display:none; gap:8px; align-items:center; }
  .viewer-controls button { background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.06); padding:8px 10px; color:var(--text); border-radius:6px; cursor:pointer; font-size:13px; }
  #status { position:absolute; left:12px; top:12px; z-index:9999; font-size:13px; color: #9fb2b8; }
  #meetFrame { width:100%; height:100vh; border:0; display:block; background:var(--bg); }
</style>
</head>
<body>
<div id="jaas" aria-label="meeting">
  <div id="status">Connecting…</div>
  <div class="viewer-controls" id="viewerControls">
    <button id="btnFullscreen">Fullscreen</button>
  </div>
</div>

<script>
(async()=>{
  const SERVICE_BASE = "https://oor-islive.onrender.com";
  const ROOM = "AyushLive"; // optional, server can ignore this

  const statusEl = document.getElementById('status');
  const viewerControls = document.getElementById('viewerControls');

  function setStatus(text){ if(statusEl) statusEl.textContent = text; }

  async function toggleFullscreen(){
    const el = document.getElementById('jaas');
    if(!document.fullscreenElement){ await el.requestFullscreen().catch(()=>{}); }
    else { await document.exitFullscreen().catch(()=>{}); }
  }
  document.getElementById('btnFullscreen')?.addEventListener('click', toggleFullscreen);

  async function requestAndEmbed(){
    setStatus('Requesting secure join URL…');
    try{
      const resp = await fetch(`${SERVICE_BASE}/api/request-join`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ room: ROOM })
      });

      if(!resp.ok){
        const err = await resp.text().catch(()=>null);
        console.error('request-join failed', resp.status, err);
        setStatus('Unable to get join link');
        return;
      }

      const data = await resp.json();
      if(!data?.joinUrl){
        console.error('unexpected response', data);
        setStatus('Failed to get join link');
        return;
      }

      setStatus('Embedding meeting…');

      const iframe = document.createElement('iframe');
      iframe.id = 'meetFrame';
      iframe.allow = 'camera; microphone; fullscreen; clipboard-write';
      iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups';

      // **Embed the ephemeral join URL, server will inject actual provider iframe**
      iframe.src = data.joinUrl;

      const jaas = document.getElementById('jaas');
      jaas.innerHTML = '';
      jaas.appendChild(iframe);

      if(viewerControls) viewerControls.style.display = 'flex';
      setStatus('Joined — enjoy the meeting');

    } catch(e){
      console.error('requestAndEmbed error', e);
      setStatus('Network error — retrying in 3s…');
      setTimeout(requestAndEmbed, 3000);
    }
  }

  window.addEventListener('load', requestAndEmbed);
})();
</script>
</body>
</html>
