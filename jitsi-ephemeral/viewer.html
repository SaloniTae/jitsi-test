<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Viewer — Protected embed</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --bg:#000; --text:#e6f0f3; }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);overflow:hidden;font-family:system-ui,Arial,Helvetica,sans-serif;}
  #jaas{height:100vh;width:100vw;position:relative;overflow:hidden;background:var(--bg);}
  #status{position:absolute;top:12px;left:12px;z-index:9999;font-size:13px;color:#9fb2b8;}
  .viewer-controls{position:absolute;top:12px;right:12px;z-index:9999;display:none;gap:8px;}
  .viewer-controls button{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);padding:8px 10px;color:var(--text);border-radius:6px;cursor:pointer;font-size:13px;}
  #meetFrame{width:100%;height:100vh;border:0;display:block;}
</style>
</head>
<body>
<div id="jaas">
  <div id="status">Connecting…</div>
  <div class="viewer-controls" id="viewerControls">
    <button id="btnFullscreen">Fullscreen</button>
  </div>
</div>

<script>
(async()=>{
  const SERVICE_BASE = "https://oor-islive.onrender.com";

  const statusEl = document.getElementById('status');
  const viewerControls = document.getElementById('viewerControls');

  function setStatus(txt){ if(statusEl) statusEl.textContent = txt; }

  async function requestAndEmbed(){
    setStatus('Requesting join link…');
    try{
      const resp = await fetch(`${SERVICE_BASE}/api/request-join`, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({})
      });
      if(!resp.ok){ setStatus('Failed to get join link'); return; }
      const data = await resp.json();
      if(!data || !data.fullJoinUrl){ setStatus('Invalid response'); return; }

      setStatus('Embedding meeting…');

      const iframe = document.createElement('iframe');
      iframe.id = 'meetFrame';
      iframe.allow = 'camera; microphone; fullscreen; autoplay';
      iframe.allowFullscreen = true;
      iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups';
      iframe.src = data.fullJoinUrl;

      const jaas = document.getElementById('jaas');
      jaas.innerHTML = '';
      jaas.appendChild(iframe);

      if(viewerControls) viewerControls.style.display='flex';
      setStatus('Joined');

    }catch(err){ console.error(err); setStatus('Network error…'); setTimeout(requestAndEmbed,3000); }
  }

  // Fullscreen button
  const fsBtn = document.getElementById('btnFullscreen');
  if(fsBtn) fsBtn.addEventListener('click',()=>{
    const el = document.getElementById('jaas');
    if(!document.fullscreenElement) el.requestFullscreen?.(); 
    else document.exitFullscreen?.();
  });

  window.addEventListener('load',()=>requestAndEmbed());
})();
</script>
</body>
</html>
