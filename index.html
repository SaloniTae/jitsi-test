<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Viewer — Host-first (works on mobile fullscreen)</title>

  <!-- Use meet.jit.si for quick testing. If you use JaaS replace hostname below. -->
  <script src="https://meet.jit.si/external_api.js"></script>

  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Inter,Arial,Helvetica,sans-serif}
    #video-wrap{height:calc(100vh - 56px);position:relative;display:flex;align-items:center;justify-content:center;background:#000}
    #jaas{width:100%;height:100%;background:#000}
    #placeholder{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#bbb;z-index:3;font-size:18px;background:#000}
    #controls{height:56px;display:flex;align-items:center;justify-content:center;background:#111}
    button{padding:10px 14px;border-radius:8px;background:#333;color:#fff;border:0;cursor:pointer;font-size:15px}
    button[disabled]{opacity:.45;cursor:not-allowed}
    /* ensure iframe fills container */
    #jaas iframe { width:100% !important; height:100% !important; border:0; display:block; }
    /* on fullscreen, outer container stays black (no blur) */
    :fullscreen #video-wrap, :-webkit-full-screen #video-wrap { background:#000; }
  </style>
</head>
<body>

  <div id="video-wrap" role="region" aria-live="polite">
    <div id="placeholder">Waiting for host to join and share screen / video…</div>
    <div id="jaas" aria-label="meeting"></div>
  </div>

  <div id="controls">
    <button id="fsBtn" disabled>Fullscreen</button>
  </div>

<script>
/*
 Simple, robust viewer page:
 - Quick test uses meet.jit.si, same ROOM as host
 - Hides toolbar for viewers, placeholder until host publishes,
 - Pins host and forces single-large view on fullscreen/orientation change
*/

// ===== CONFIG =====
const ROOM = "Ayush37299"; // use same room name as host (meet.jit.si/ROOM)
const HOST_API_HOST = "meet.jit.si"; // change to "8x8.vc" if using JaaS and set jwt below
const JWT = ""; // optional: if using JaaS, put viewer JWT here (leave empty for meet.jit.si quick test)
// ===================

const placeholder = document.getElementById('placeholder');
const fsBtn = document.getElementById('fsBtn');
const jaasContainer = document.getElementById('jaas');
const videoWrap = document.getElementById('video-wrap');

let api = null;
let joined = false;
let lastPinnedId = null;

// random viewer name
const viewerName = "Viewer-" + Math.floor(Math.random() * 9000 + 1000);

// Init Jitsi External API (run after script loaded)
(function init() {
  const options = {
    roomName: ROOM,
    parentNode: jaasContainer,
    userInfo: { displayName: viewerName },
    configOverwrite: {
      prejoinPageEnabled: false,
      startWithAudioMuted: true,
      startWithVideoMuted: true,
      disableDeepLinking: true,
      enableWelcomePage: false
    },
    interfaceConfigOverwrite: {
      TOOLBAR_BUTTONS: [],      // hide buttons for viewers
      SHOW_JITSI_WATERMARK: false,
      SHOW_BRAND_WATERMARK: false,
      SHOW_POWERED_BY: false
    },
    width: "100%",
    height: "100%"
  };
  if (JWT && JWT.trim()) options.jwt = JWT;

  try {
    api = new JitsiMeetExternalAPI(HOST_API_HOST, options);
    window.__jitsiApi = api; // debug hook
  } catch (err) {
    console.error("Jitsi init failed:", err);
    placeholder.textContent = "Failed to initialize meeting. See console.";
    return;
  }

  // viewer joined
  api.addEventListener('videoConferenceJoined', () => {
    joined = true;
    fsBtn.disabled = false;
    // try to pin if host already present
    attemptPinHost();
  });

  // when someone joins — attempt pin (host may join later)
  api.addEventListener('participantJoined', (p) => {
    setTimeout(attemptPinHost, 700);
  });

  // when remote turns on camera, hide placeholder and pin them
  api.addEventListener('participantVideoStatusChanged', (evt) => {
    const pid = evt && (evt.participantId || evt.id);
    if (evt && (evt.videoStatus === true) && pid && pid !== api.getCurrentUserID()) {
      hidePlaceholder();
      pinCandidate(pid);
    }
  });

  // when someone starts screen sharing
  api.addEventListener('screenSharingStatusChanged', (payload) => {
    if (payload && payload.on) {
      // payload can sometimes include id
      const pid = payload && (payload.participantId || payload.id || payload.participant);
      hidePlaceholder();
      if (pid) pinCandidate(pid);
      else attemptPinHost();
    } else {
      // when screen sharing stops, re-check if webcam is active
      setTimeout(attemptPinHost, 700);
    }
  });

  // if someone left, re-evaluate
  api.addEventListener('participantLeft', (p) => {
    // if the pinned left, clear and re-run detection
    if (p && (p.id === lastPinnedId || p.participantId === lastPinnedId)) {
      lastPinnedId = null;
      setTimeout(attemptPinHost, 500);
    }
  });

  // periodic attempt — helpful for late viewers
  setInterval(() => { if (joined) attemptPinHost(); }, 3500);

  // fullscreen/orientation handling: force single large view and re-pin host
  async function onFullOrOrient() {
    // small delay for layout changes
    setTimeout(async () => {
      try { api.executeCommand('setTileView', false); } catch (e) {}
      await attemptPinHost();
      // repeat pin a couple of times to overcome mobile timing
      setTimeout(() => { if (lastPinnedId) try { api.executeCommand('pinParticipant', lastPinnedId); } catch(e){} }, 350);
      setTimeout(() => { if (lastPinnedId) try { api.executeCommand('pinParticipant', lastPinnedId); } catch(e){} }, 800);
    }, 200);
  }
  document.addEventListener('fullscreenchange', onFullOrOrient);
  window.addEventListener('orientationchange', onFullOrOrient);

})();

// Helpers

function hidePlaceholder(){ placeholder.style.display = 'none'; }
function showPlaceholder(){ placeholder.style.display = 'flex'; }

function pinCandidate(pid){
  if (!pid || !api) return;
  try { api.executeCommand('setTileView', false); } catch(e){}
  try { api.executeCommand('pinParticipant', pid); lastPinnedId = pid; } 
  catch (err) {
    try { api.executeCommand('setLargeVideoParticipant', pid); lastPinnedId = pid; } catch(e){ console.warn('pin failed', e); }
  }
  hidePlaceholder();
}

// Attempt to determine a sensible host candidate and pin them.
// This uses getParticipantsInfo() (if available), otherwise falls back to the last remote id we observed.
async function attemptPinHost() {
  if (!api) return;
  // prefer quick events-based lastPinnedId if already set
  if (lastPinnedId) {
    try { pinCandidate(lastPinnedId); return; } catch(e){}
  }
  // try getParticipantsInfo if available
  try {
    if (typeof api.getParticipantsInfo === 'function') {
      const info = api.getParticipantsInfo();
      const list = (info && typeof info.then === 'function') ? await info : info;
      if (Array.isArray(list)) {
        // heuristics: screen sharer first, then any remote with video, then any remote
        for (const p of list) {
          const pid = p.participantId || p.id || p.participant;
          if (!pid || pid === api.getCurrentUserID()) continue;
          const features = p.features || {};
          const isSharing = p.isScreensharing || p.isSharingScreen || features.screenSharing;
          if (isSharing) { pinCandidate(pid); return; }
        }
        for (const p of list) {
          const pid = p.participantId || p.id || p.participant;
          if (!pid || pid === api.getCurrentUserID()) continue;
          if (p.hasVideo || p.videoStatus || p.video) { pinCandidate(pid); return; }
        }
        for (const p of list) {
          const pid = p.participantId || p.id || p.participant;
          if (!pid || pid === api.getCurrentUserID()) continue;
          pinCandidate(pid); return;
        }
      }
    }
  } catch (e) {
    console.warn('getParticipantsInfo failed', e);
  }
  // nothing found — keep placeholder visible
  showPlaceholder();
}

// Fullscreen button logic: only enabled after join
fsBtn.addEventListener('click', async () => {
  if (!api || !joined) {
    placeholder.textContent = "Joining meeting — please wait";
    return;
  }
  // fullscreen outer wrapper
  try {
    if (videoWrap.requestFullscreen) await videoWrap.requestFullscreen();
    else if (videoWrap.webkitRequestFullscreen) await videoWrap.webkitRequestFullscreen();
    else if (videoWrap.msRequestFullscreen) await videoWrap.msRequestFullscreen();
  } catch (err) {
    console.warn('fullscreen failed', err);
  }
});

// export debug helpers
window.__viewer = {
  attemptPinHost,
  pinCandidate,
  apiRef: () => api
};
</script>
</body>
</html>
