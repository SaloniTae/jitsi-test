<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Viewer</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- JaaS external_api.js -->
<script src="https://8x8.vc/vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/external_api.js"></script>

<style>
 :root { --bg:#000; --text:#e6f0f3; }
 html,body{
   height:100%;margin:0;overflow:hidden;
   font-family:system-ui,Arial,Helvetica,sans-serif;
   background:var(--bg);color:var(--text);
 }
 #jaas{height:100vh;width:100vw;position:relative;background:var(--bg);overflow:hidden;}
 .viewer-controls{
   position:absolute;right:12px;top:12px;z-index:9999;display:none;gap:8px;align-items:center;
 }
 .viewer-controls button{
   background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.06);
   padding:8px 10px;color:var(--text);border-radius:6px;cursor:pointer;font-size:13px;
 }
 .force-landscape{
   position:fixed !important;top:50%!important;left:50%!important;
   width:100vh!important;height:100vw!important;
   transform:translate(-50%,-50%) rotate(90deg)!important;
   transform-origin:center center!important;background:var(--bg)!important;
   overflow:hidden!important;z-index:99999!important;
 }
 #unauth{
   position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
   background:#000;color:#e33;font-size:22px;font-weight:600
 }
</style>
</head>
<body>
  <div id="jaas" aria-label="meeting">
    <div class="viewer-controls" id="viewerControls">
      <button id="btnFullscreen">Fullscreen</button>
    </div>
    <div id="unauth" style="display:none">Unauthorized</div>
  </div>

<script>
(function(){

/* -------------------------------------------------
   1)  Read order-id from query string
--------------------------------------------------*/
const qs  = new URLSearchParams(location.search);
const ORDER_ID = (qs.get('user')||'').trim();
if(!ORDER_ID){
  document.getElementById('unauth').style.display='flex';
  return;        // nothing else should run
}

/* -------------------------------------------------
   2)  Jitsi constants
--------------------------------------------------*/
const ROOM      = "vpaas-magic-cookie-45b14c029c1e43698634a0ad0d0838a9/AyushLive";
const DOMAIN    = "8x8.vc";
const ROOM_PASS = "12345";         // auto-set / auto-enter

let api=null, isCSSRotate=false;

/* -------------------------------------------------
   3)  Helpers  (mobile orientation, fullscreen, etc.)
--------------------------------------------------*/
function isMob(){ try{
  return (('ontouchstart'in window)||(navigator.maxTouchPoints>0))
         && window.innerWidth<=900;
} catch(e){ return false; }}

function ensureHideFilmstrip(a){
  setTimeout(()=>{ try{a.executeCommand('toggleFilmStrip');}catch(e){} },300);
}

/*  ----------  orientation / fullscreen ---------- */
function tryLock(o){
  if(screen.orientation&&screen.orientation.lock) return screen.orientation.lock(o);
  const fn=screen.lockOrientation||screen.mozLockOrientation||screen.msLockOrientation;
  if(fn) try{ fn.call(screen,o); }catch(e){}
}
function tryUnlock(){
  if(screen.orientation&&screen.orientation.unlock) screen.orientation.unlock();
}
function cssRotate(){
  if(isCSSRotate||!isMob()) return;
  document.body.style.overflow='hidden';
  document.getElementById('jaas').classList.add('force-landscape');
  isCSSRotate=true;
}
function clearCssRotate(){
  if(!isCSSRotate) return;
  document.getElementById('jaas').classList.remove('force-landscape');
  document.body.style.overflow='';
  isCSSRotate=false;
}
async function enterFS(){
  const el=document.getElementById('jaas');
  if(el.requestFullscreen) await el.requestFullscreen();
  try{ await tryLock('landscape'); clearCssRotate(); }
  catch(e){ cssRotate(); }
}
async function exitFS(){
  if(document.exitFullscreen) await document.exitFullscreen();
  tryUnlock(); clearCssRotate();
}
function toggleFS(){
  const full=document.fullscreenElement;
  full ? exitFS() : enterFS();
}
document.addEventListener('fullscreenchange', ()=>{
  if(!document.fullscreenElement){ tryUnlock(); clearCssRotate(); }
});

/* -------------------------------------------------
   4)  Initialise Jitsi
--------------------------------------------------*/
function initJitsi(){
  if(api) return;
  api=new JitsiMeetExternalAPI(DOMAIN,{
    roomName:ROOM,
    parentNode:document.getElementById('jaas'),
    userInfo:{displayName:ORDER_ID},
    configOverwrite:{
      prejoinPageEnabled:false,prejoinConfig:{enabled:false},
      disableInitialGUM:true,startWithAudioMuted:true,startWithVideoMuted:true,
      filmstrip:{disabled:true},desktopSharingFrameRate:{min:15,max:30}
    },
    interfaceConfigOverwrite:{
      TOOLBAR_BUTTONS:[],
      SHOW_JITSI_WATERMARK:false,SHOW_BRAND_WATERMARK:false,SHOW_POWERED_BY:false,
      SHOW_DEEP_LINKING_IMAGE:false,SHOW_WATERMARK_FOR_GUESTS:false,
      VIDEO_LAYOUT_FIT:'both',DISABLE_VIDEO_BACKGROUND:true
    },
    width:'100%',height:'100%'
  });

  /* auto-password */
  api.on('participantRoleChanged',e=>{
    if(e.role==='moderator') api.executeCommand('password',ROOM_PASS);
  });
  api.on('passwordRequired',()=> api.executeCommand('password',ROOM_PASS));

  api.on('videoConferenceJoined', async ()=>{
    document.getElementById('viewerControls').style.display='flex';
    ensureHideFilmstrip(api);
  });
  api.on('videoConferenceLeft', ()=>{
    document.getElementById('viewerControls').style.display='none';
  });
}

/* -------------------------------------------------
   5)  Boot
--------------------------------------------------*/
window.addEventListener('load',()=>{
  document.getElementById('btnFullscreen').onclick = toggleFS;
  initJitsi();
});

})();
</script>
</body>
</html>
